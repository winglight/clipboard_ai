<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>智能跳绳计数器</title>
    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.js"></script>
    <script src="https://unpkg.com/ml5@latest/dist/ml5.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            background-color: #f0f0f0;
        }
        #app {
            text-align: center;
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        button {
            margin: 10px;
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
        }
        #video {
            max-width: 100%;
            height: auto;
        }
        progress {
            width: 100%;
            height: 20px;
        }
    </style>
</head>
<body>
    <div id="app">
        <div v-if="currentPage === 'home'">
            <h1>智能跳绳计数器</h1>
            <p>跳绳次数：{{ jumpCount }}</p>
            <p>运动时间：{{ formatTime(elapsedTime) }}</p>
            <button @click="startCounting" v-if="!isCounting">开始计数</button>
            <button @click="stopCounting" v-else>停止计数</button>
            <button @click="resetCount">重置计数</button>
            <button @click="showTips">跳绳技巧和建议</button>
            <button @click="showGoals">查看目标和进度</button>
            <button @click="showAchievements">查看成就</button>
            <video id="video" ref="video" width="640" height="480" autoplay></video>
        </div>

        <div v-else-if="currentPage === 'tips'">
            <h2>跳绳技巧和建议</h2>
            <ul>
                <li>保持正确的姿势：背部挺直，目视前方</li>
                <li>使用脚掌着地，而不是整个脚掌</li>
                <li>保持手肘靠近身体，主要使用手腕旋转绳子</li>
                <li>跳跃高度不需要太高，只要能让绳子通过即可</li>
                <li>保持均匀的节奏，找到适合自己的速度</li>
                <li>开始时每天跳10-15分钟，逐渐增加时间</li>
                <li>注意保持呼吸均匀，与跳绳节奏协调</li>
                <li>选择合适的跳绳长度：站立时绳子两端应该刚好到腋下</li>
                <li>定期更换跳绳，以确保最佳性能</li>
                <li>在软质地面上跳绳，如橡胶垫或木地板，以减少对关节的压力</li>
            </ul>
            <button @click="goToHome">返回主页</button>
        </div>

        <div v-else-if="currentPage === 'goals'">
            <h2>跳绳目标和进度</h2>
            <div>
                <h3>每日目标：{{ dailyGoal }} 次</h3>
                <progress :value="progress.daily" max="100"></progress>
                <span>{{ progress.daily.toFixed(1) }}%</span>
            </div>
            <div>
                <h3>每周目标：{{ weeklyGoal }} 次</h3>
                <progress :value="progress.weekly" max="100"></progress>
                <span>{{ progress.weekly.toFixed(1) }}%</span>
            </div>
            <div>
                <h3>每月目标：{{ monthlyGoal }} 次</h3>
                <progress :value="progress.monthly" max="100"></progress>
                <span>{{ progress.monthly.toFixed(1) }}%</span>
            </div>
            <button @click="setGoals">设置新目标</button>
            <button @click="goToHome">返回主页</button>
        </div>

        <div v-else-if="currentPage === 'achievements'">
            <h2>成就</h2>
            <ul>
                <li v-for="(achievement, index) in achievements" :key="index">
                    {{ achievement.name }}: {{ achievement.unlocked ? '已解锁' : '未解锁' }}
                    <span v-if="!achievement.unlocked">(进度: {{ achievement.progress }}/{{ achievement.target }})</span>
                </li>
            </ul>
            <button @click="goToHome">返回主页</button>
        </div>
    </div>

    <script>
        let bodyPose=ml5.bodyPose();
        console.log('PoseNet模型加载完成');
        (async function() {
            new Vue({
                el: '#app',
                data: {
                    currentPage: 'home',
                    jumpCount: 0,
                    isCounting: false,
                    startTime: 0,
                    elapsedTime: 0,
                    timer: null,
                    groundLevel: 0,
                    shoulderLevel: 0,
                    hipLevel: 0,
                    dailyGoal: 1000,
                    weeklyGoal: 7000,
                    monthlyGoal: 30000,
                    progress: {
                        daily: 0,
                        weekly: 0,
                        monthly: 0
                    },
                    achievements: [
                        { name: '初学者', target: 100, progress: 0, unlocked: false },
                        { name: '进阶者', target: 1000, progress: 0, unlocked: false },
                        { name: '专家', target: 10000, progress: 0, unlocked: false },
                        { name: '大师', target: 100000, progress: 0, unlocked: false }
                    ],
                    isJumping: false
                },
                methods: {
                    startCounting() {
                        this.isCounting = true;
                        this.startTime = Date.now() - this.elapsedTime;
                        this.timer = setInterval(() => {
                            this.elapsedTime = Date.now() - this.startTime;
                        }, 1000);
                        this.setupPoseDetection();
                    },
                    stopCounting() {
                        this.isCounting = false;
                        clearInterval(this.timer);
                    },
                    resetCount() {
                        this.jumpCount = 0;
                        this.elapsedTime = 0;
                        this.updateProgress();
                        this.updateAchievements();
                    },
                    formatTime(ms) {
                        const seconds = Math.floor(ms / 1000);
                        const minutes = Math.floor(seconds / 60);
                        const hours = Math.floor(minutes / 60);
                        return `${hours}:${minutes % 60}:${seconds % 60}`;
                    },
                    async setupPoseDetection() {
                        const video = this.$refs.video;
                        try {
                            const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                            video.srcObject = stream;
                            await video.play();
        
                            // const poseNet = await ml5.poseNet(video);
                            // poseNet.on('pose', this.gotPoses);
                            // Start detecting poses in the webcam video
                            bodyPose.detectStart(video, this.gotPoses);
                            
                        } catch (error) {
                            console.error('设置姿势检测时出错:', error);
                        }
                    },
                    gotPoses(poses) {
                        if (poses.length > 0) {
                            const pose = poses[0].pose;
                            const leftAnkle = pose.leftAnkle;
                            const rightAnkle = pose.rightAnkle;
                            const leftShoulder = pose.leftShoulder;
                            const rightShoulder = pose.rightShoulder;
                            const leftHip = pose.leftHip;
                            const rightHip = pose.rightHip;

                            this.groundLevel = Math.max(leftAnkle.y, rightAnkle.y);
                            this.shoulderLevel = (leftShoulder.y + rightShoulder.y) / 2;
                            this.hipLevel = (leftHip.y + rightHip.y) / 2;

                            this.detectJump();
                        }
                    },
                    detectJump() {
                        const jumpThreshold = 30; // 可以根据需要调整这个值
                        const currentHeight = this.groundLevel - this.hipLevel;

                        if (currentHeight > jumpThreshold && !this.isJumping) {
                            this.isJumping = true;
                        } else if (currentHeight <= jumpThreshold && this.isJumping) {
                            this.isJumping = false;
                            this.jumpCount++;
                            this.updateProgress();
                            this.updateAchievements();
                        }
                    },
                    showTips() {
                        this.currentPage = 'tips';
                    },
                    showGoals() {
                        this.currentPage = 'goals';
                    },
                    showAchievements() {
                        this.currentPage = 'achievements';
                    },
                    goToHome() {
                        this.currentPage = 'home';
                    },
                    setGoals() {
                        this.dailyGoal = parseInt(prompt("请设置每日跳绳目标次数：", this.dailyGoal)) || this.dailyGoal;
                        this.weeklyGoal = parseInt(prompt("请设置每周跳绳目标次数：", this.weeklyGoal)) || this.weeklyGoal;
                        this.monthlyGoal = parseInt(prompt("请设置每月跳绳目标次数：", this.monthlyGoal)) || this.monthlyGoal;
                        this.updateProgress();
                    },
                    updateProgress() {
                        this.progress.daily = Math.min(100, (this.jumpCount / this.dailyGoal) * 100);
                        this.progress.weekly = Math.min(100, (this.jumpCount * 7 / this.weeklyGoal) * 100);
                        this.progress.monthly = Math.min(100, (this.jumpCount * 30 / this.monthlyGoal) * 100);
                    },
                    updateAchievements() {
                        this.achievements.forEach(achievement => {
                            achievement.progress = Math.min(achievement.target, this.jumpCount);
                            achievement.unlocked = this.jumpCount >= achievement.target;
                        });
                    }
        }
    });
})();
</script>
</body>
</html>
